
{% extends "base.html" %}
{% block content %}

	<body>
		<div class="container-fluid">
			
			<div class="row">
				<div class="col-md-8">
					<h2><span class="text-muted">Session:</span> {{ escape(session['name'])}} </h2>
				</div>
				<div class="col-md-2">
                    {% if prev %}
                    <a href="/sessions/{{prev}}/"><<{{prev}}</a>
                    {% end %}
                </div>
				<div class="col-md-2">
                    {% if next %}
                    <a href="/sessions/{{next}}/">{{next}}>></a>
                    {% end %}
				</div>
			</div>
            <div class="row">
                <div class="col-md-12">
                    {% for tag in tags %}
                    <button type="button" class="btn btn-xs tagging btn-info {{'active' if tag in session_tags else ''}}" data-dirname="{{session['name']}}" data-tagname="{{tag}}"  data-toggle="button" aria-pressed="false" autocomplete="off" onclick="tagToggled(this)">
                            {{tag}}
                        </button>
                    {% end %}
                </div>
            </div>
			<div class="row">
				<div class="col-md-12 session-thumbnails">
					<ol id="selectable">
						<p class="text-muted"><em>Click and drag to select images, command + click to select multiple single images.</em></p>
						{% for img in session['imgs'] %}					
							<li class="thumbnail" id="{{session['name']}}/{{ img['name'] }}">
								<img src="/session_image/{{session['name']}}/{{ img['name'] }}" class="img-responsive">
								<div class="caption">
									<p class="small desc" />
								</div>
							</li>
						{% end %}
					</ol>
				</div>
			</div>
		</div>

	<footer class='footer' >
		<div class="container-fluid">
			
			<div class="col-md-5">
				<nav aria-label="Page navigation">
					<ul class="pagination">
						<li>
							<a href="./{{this_page - 1}}" aria-label="Previous">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>

						{% for p in page_list %}
							<li ><a href="./{{p}}"> {{p}} </a></li>
						{% end %}

						<li>
							<a href="./{{this_page + 1}}" aria-label="Next">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>
					</ul>
				</nav>
			</div>
            
            <div class="col-md-2 img-controls">
				<div class="form-inline">
                    <form method="GET" action="download">
					<input class="btn btn-default" type="submit" value="Download .zip" id="download">
                    </form>
                </div>
			</div>
			
			<div class="col-md-5 img-controls text-right">
				<div class="form-inline">
					<label>
						<span id="select-result">0</span> selected
					</label>
					<label class="btn btn-default">
						<input id="select-all" type="checkbox"> Select All
					</label>
					<input class="btn btn-danger" type="button" value="Delete Selected" id="delete-all">
				</div>
			</div>
			
		</div>
	</footer>

	<div class='meta' style="display:none">
		<span id="session_id" data-id={{ escape(session['name'])}}>session_id:  {{ escape(session['name'])}} </span>
	</div>

	<script>
		$(document).ready(function() {
			
			$( "#selectable" ).selectable({
			  filter: 'li',
				stop: function() {
					$( "#select-result" ).text(function( index ) {
					  return $('.ui-selected').length;
					});
      	}
			});
			
			$('#select-all').on('click', function () {
				if ($(this).is(":checked")) {
					$('.thumbnail').addClass('ui-selected');
				} else {
					$('.thumbnail').removeClass('ui-selected');
				}
				
				$( "#select-result" ).text(function( index ) {
					return $('.ui-selected').length;
				});
			})

			$('#delete-all').click(function(){
				var selected = []

				// Build array of selected images
				$(".ui-selected").each(function() {
					selected.push(this.id);
				});
				
				console.log(selected);

				//Send post request to server.
				data = JSON.stringify({ 'imgs': selected,
																'session_id': $('#session_id').data('id'),
																'action':'delete_images'});

				console.log(data);
				$.post('', data);
				
				//Remove deleted images from page
				$(selected).each(function( index, value ) {
					console.log(value);
					$("[id='" + value + "']").remove();
					$( "#selectable" ).selectable( "refresh" );
				});
			});
			
            $(document).keydown(function(e) {
                if (!e.ctrlKey) {
                    return;
                }

                if (e.which >= 49 && e.which < 59) {
                    var i = e.which - 49;
                    
                    if (i >= all_tags.length) {
                        return;
                    }

                    tagToggled(all_tags[i]);

                    e.preventDefault(); // prevent the default action (scroll / move caret)
                }
            });
            loadTags();
		} );

var all_tags = [];

var tagToggled = function(tagName) {
    var targets = $('.ui-selected').toArray().map(function(el) {return el.id})
    //var verb = $(el).hasClass('active') ? 'DELETE' : 'PUT';  // class has not changed when onclick is called. So having 'active' means 'it's about to become inactive
    $.ajax({
        url: '/api/tags/' + tagName + '/',
        type: 'PUT',
        data: JSON.stringify({targets}),
	    contentType: "application/json; charset=utf-8",
	    dataType: "json",
        complete: loadTags,
    })
}

var loadTags = function() {
    $.ajax({
        url: "/api/tags/",
        type: 'GET',
	    dataType: "json",
        success: function(result) {
            all_tags = result.all_tags;
            $('li.thumbnail.ui-selectee').each( function(_, el) {
                var tags = result.targets[el.id] || ['None'];
                $(el).find('.caption p').text(tags.join(','));
            })
        }
    });
}
	</script>

	</body>
{% end %}
